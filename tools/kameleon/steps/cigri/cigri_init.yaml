cigri_init:
 - start_psql:
   - exec_chroot: bash -c "/etc/init.d/postgresql start"
   - exec_on_clean: chroot $$chroot bash -c "\"/etc/init.d/postgresql stop\""
 - init_db:
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn`/database && ./init_db.rb -d cigri3 -u cigri3 -p cigri3 -t psql -s ./psql_structure.sql"
 - create_user: 
   - exec_chroot: bash -c "useradd -m -d /var/lib/cigri -c \"Cigri server\" cigri"
 - install_cigri:
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && make install"
 - init_clusters:
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && ./sbin/new_cluster.rb tchernobyl https://tchernobyl/oarapi-secured/ kameleon kameleon tchernobyl oar2_5 core 100 \"cluster='tchernobyl'\""
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && ./sbin/new_cluster.rb threemile https://threemile/oarapi-secured/ kameleon kameleon threemile oar2_5 core 10 \"cluster='threemile'\""
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && ./sbin/new_cluster.rb fukushima https://fukushima/oarapi-secured/ kameleon kameleon fukushima oar2_5 core 50 \"cluster='fukushima'\""
 - activate_api:
   - exec_chroot: ln -s /etc/cigri/api-apache.conf /etc/apache2/conf.d/cigri-api.conf
 - cigri_certificate:
   - exec_chroot: mkdir /etc/cigri/ssl
   - exec_chroot: chown cigri /etc/cigri/ssl
   - exec_chroot: chmod 700 /etc/cigri/ssl
   - write_file:
     - /etc/cigri/ssl/cigri.cnf
     - |
       [ req ]
       default_bits           = 1024
       default_keyfile        = cigri.pem
       distinguished_name     = req_distinguished_name
       attributes             = req_attributes
       prompt                 = no
       
       [ req_distinguished_name ]
       C                      = FR
       ST                     = Default CIGRI Province
       L                      = Default CIGRI Locality
       O                      = Default CIGRI O
       OU                     = Default CIGRI OU
       CN                     = Default CIGRI CN
       emailAddress           = gridmaster@ujf-grenoble.fr
       
       [ req_attributes ]
       challengePassword              = cigri
   - exec_chroot: openssl genrsa -out /etc/cigri/ssl/cigri.key 1024
   - exec_chroot: openssl req -config /etc/cigri/ssl/cigri.cnf -new -key /etc/cigri/ssl/cigri.key -out /etc/cigri/ssl/cigri.csr
   - exec_chroot: openssl x509 -req -days 3650 -in /etc/cigri/ssl/cigri.csr -CA /etc/ssl/certs/ssl-cert-snakeoil.pem -CAkey /etc/ssl/private/ssl-cert-snakeoil.key -CAcreateserial -out /etc/cigri/ssl/cigri.crt
 - oar_https_api:
   - exec_chroot: bash -c "a2ensite default-ssl"
   - exec_chroot: bash -c "a2enmod ssl"
   - exec_chroot: rm -f /etc/apache2/conf.d/oar-restful-api.conf
   - write_file:
     - /etc/apache2/conf.d/oar-restful-api-secured.conf
     - |
       ScriptAlias /oarapi-secured /usr/local/lib/cgi-bin/oarapi/oarapi.cgi
       <Location /oarapi-secured>
         Options ExecCGI -MultiViews FollowSymLinks
          SSLVerifyClient require
          SSLVerifyDepth  1
          SSLCACertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
       </Location>

