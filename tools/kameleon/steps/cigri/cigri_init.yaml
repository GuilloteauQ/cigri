cigri_init:
 - start_psql:
   - exec_chroot: bash -c "/etc/init.d/postgresql start"
   - exec_on_clean: chroot $$chroot bash -c "\"/etc/init.d/postgresql stop\""
 - init_db:
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn`/database && ./init_db.rb -d cigri3 -u cigri3 -p cigri3 -t psql -s ./psql_structure.sql"
 - create_user: 
   - exec_chroot: bash -c "useradd -m -d /var/lib/cigri -c \"Cigri server\" cigri"
 - install_cigri:
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && make install-cigri"
 - init_clusters:
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && ./sbin/new_cluster.rb tchernobyl https://tchernobyl/oarapi-secured/ cert kameleon kameleon '' tchernobyl oar2_5 core 100 \"cluster='tchernobyl'\""
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && ./sbin/new_cluster.rb threemile https://threemile/oarapi-secured/ cert kameleon kameleon '' threemile oar2_5 core 10 \"cluster='threemile'\""
   - exec_chroot: bash -c "cd /home/kameleon/`basename $$cigri_svn` && ./sbin/new_cluster.rb fukushima https://fukushima/oarapi-secured/ cert kameleon kameleon '' fukushima oar2_5 core 50 \"cluster='fukushima'\""
 - activate_api:
   - exec_chroot: ln -s /etc/cigri/api-apache.conf /etc/apache2/conf.d/cigri-api.conf
 - oar_https_api:
   - exec_chroot: bash -c "a2ensite default-ssl"
   - exec_chroot: bash -c "a2enmod ssl"
   - write_file:
     - /etc/apache2/conf.d/oar-restful-api-secured.conf
     - |
       ScriptAlias /oarapi-secured /usr/local/lib/cgi-bin/oarapi/oarapi.cgi
       <Location /oarapi-secured>
         Options ExecCGI -MultiViews FollowSymLinks
          SSLVerifyClient require
          SSLVerifyDepth  1
          SSLCACertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
          ## Add some checks on the X_REMOTE_IDENT header
          ## This example only allows users kameleon and oar to be authenticated to the API
          # RewriteEngine On
          # RewriteCond %{HTTP:X_REMOTE_IDENT}  (.*)
          # RewriteRule .* - [E=MY_REMOTE_IDENT:%1]
          # RewriteCond %{HTTP:X_REMOTE_IDENT}  !=kameleon
          # RewriteCond %{HTTP:X_REMOTE_IDENT}  !=oar
          # RewriteRule .* - [E=MY_REMOTE_IDENT:]
          # RequestHeader set X_REMOTE_IDENT %{MY_REMOTE_IDENT}e
       </Location>
 - oar_api:
   - write_file:
     - /etc/oar/apache2/oar-restful-api.conf
     - |
       ScriptAlias /oarapi /usr/local/lib/cgi-bin/oarapi/oarapi.cgi
       ScriptAlias /oarapi-debug /usr/local/lib/cgi-bin/oarapi/oarapi-debug.cgi
        
       <Location /oarapi>
            <IfModule ident_module>
              IdentityCheck On
       
              <IfModule headers_module>
                # Set the X-REMOTE_IDENT http header value to REMOTE_IDENT env value
                RequestHeader set X_REMOTE_IDENT %{REMOTE_IDENT}e
                # or For https:
                #RequestHeader set X_REMOTE_IDENT %{REMOTE_IDENT}s
                # Or if it doesn't work, enable mod_rewrite and try this:
                <IfModule rewrite_module>
                   RewriteEngine On
                   RewriteCond %{REMOTE_IDENT} (.*)
                   RewriteRule .* - [E=MY_REMOTE_IDENT:%1]
                   RequestHeader add X-REMOTE_IDENT %{MY_REMOTE_IDENT}e
                </IfModule>
              </IfModule>
        
            </IfModule>
       </Location> 
        
       <Location /oarapi-debug>
            <IfModule ident_module>
              IdentityCheck On
        
              <IfModule headers_module>
                # Set the X-REMOTE_IDENT http header value to REMOTE_IDENT env value
                RequestHeader set X_REMOTE_IDENT %{REMOTE_IDENT}e
                # or For https:
                #RequestHeader set X_REMOTE_IDENT %{REMOTE_IDENT}s
                # Or if it doesn't work, enable mod_rewrite and try this:
                <IfModule rewrite_module>
                   RewriteEngine On
                   RewriteCond %{REMOTE_IDENT} (.*)
                   RewriteRule .* - [E=MY_REMOTE_IDENT:%1]
                   RequestHeader add X-REMOTE_IDENT %{MY_REMOTE_IDENT}e
                </IfModule>
              </IfModule>
         
            </IfModule>
       </Location> 
       
       # FastCGI server
       <IfModule mod_fastcgi.c>
       FastCgiServer /usr/local/lib/cgi-bin/oarapi/oarapi.cgi
       </IfModule>
        
       # Configuration for access to the API    
       <Directory /usr/local/lib/cgi-bin/oarapi>
             Options ExecCGI -MultiViews FollowSymLinks
        
            # FastCGI handler
            <IfModule mod_fastcgi.c>
            AddHandler fcgid-script .cgi
            </IfModule>
         
            # Deny access by default, except from localhost
             Order deny,allow
             #Deny from all
             #Allow from             trusted.host.mydomain
             Allow from             localhost
             Allow from             localhost.localdomain
       </Directory>
   
